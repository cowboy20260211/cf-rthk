# 节目播放列表动态获取更新

## 更新说明

已更新节目播放列表功能，现在会从RTHK网站动态获取实际的节目列表，而不是简单地生成过去30天的日期。

## 技术实现

### 更新的文件

- `src/services/rthkApi.ts` - `fetchEpisodesFromRTHK()` 函数

### 解析逻辑

#### 方法1: 解析 data-episode 属性

```typescript
// 查找页面中的 data-episode 属性
$('[data-episode]').each(el => {
  const episodeId = $el.attr('data-episode');
  const title = $el.attr('title');

  // 查找日期 (多种位置)
  let dateText = $el.find('.catBlockDate p').text();
  // 支持 DD/MM/YYYY 和 YYYY年M月D日 两种格式
});
```

#### 方法2: 解析 /episode/ 链接

```typescript
// 如果方法1没找到，查找 /episode/ 链接
$('a[href*="/episode/"]').each(el => {
  const episodeId = href.match(/\/episode\/(\d+)/)[1];
  // 同样查找日期并解析
});
```

### 支持的日期格式

1. **DD/MM/YYYY** - 例如: `19/02/2026`
   - 来源: `.catBlockDate p` 元素
   - 转换: `2026-02-19`

2. **YYYY年M月D日** - 例如: `2026年2月19日`
   - 来源: 标题或文本
   - 转换: `2026-02-19`

### 查找日期的策略

程序会按以下顺序查找日期：

1. 当前元素内的 `.catBlockDate p`
2. 父元素中的 `.catBlockDate p`
3. 相邻元素中的 `.catBlockDate p`
4. 标题文本中的日期

如果所有方法都找不到日期，该节目会被跳过。

### 备用方案

如果无法从RTHK网站获取节目列表（网络错误、HTML结构变化等），会自动降级使用原来的方法：

- 根据节目播出时间生成过去30天的日期列表
- 跳过周末（对于非体育节目）

## 测试结果

### 测试节目 1: keepuco (輕談淺唱不夜天)

- ✅ 成功获取 10 个节目
- ✅ 正确解析日期 (2026-02-19 到 2026-02-10)
- ✅ 正确生成音频URL

### 测试节目 2: musiclover (音樂情人)

- ✅ 成功获取 10 个节目
- ✅ 正确跳过周末（周二/周四不播）
- ✅ 正确解析日期

## 优势

### 1. 真实数据

- 显示网站实际的节目列表
- 包含每集的实际标题（如"今集主持: 劉沛龍"）
- 不会显示不存在的内容

### 2. 准确性

- 只显示网站上实际存在的集数
- 避免生成不存在的日期

### 3. 信息丰富

- 显示每集的特定标题
- 更好的用户体验

## 示例输出

```
节目列表 (keepuco):

2026-02-19 - 輕談淺唱不夜天
2026-02-18 - 輕談淺唱不夜天
2026-02-17 - 輕談淺唱不夜天
2026-02-16 - 今集主持: 劉沛龍
2026-02-15 - 今集主持: 劉沛龍
...
```

## 向后兼容

- ✅ 保留原有的备用方法
- ✅ 如果新方法失败，自动降级
- ✅ 不影响现有功能

## 注意事项

1. **网络依赖**: 需要访问RTHK网站
2. **HTML结构变化**: 如果RTHK更改网站结构，可能需要更新解析逻辑
3. **缓存**: 考虑添加缓存以减少网络请求

## 下一步优化

- [ ] 添加解析结果的缓存
- [ ] 支持更多日期格式
- [ ] 添加错误重试机制
- [ ] 监控解析成功率
